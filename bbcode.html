<!DOCTYPE html>
<!-- 作者：云闪 -->
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .mask {
            display: inline-block;
        }
        .mask:not(:hover),.mask:not(:hover) * {
            border: none;
            background: rgba(0,0,0,1) !important;
            color: black;
        }
        .dice {
            display: inline-block;
            width: fit-content;
            height: 25px;
            border: skyblue solid 2px;
            box-sizing: border-box;
            background-color: burlywood;
            color: dimgray;
            overflow: hidden;
            white-space: nowrap;
        }
    </style>
</head>
<body>
<div style="display: flex;">
    <label for="source">bbcode：</label>
    <textarea id="source" style="width: 600px;height: 300px"></textarea>
    <div>可用bbcode
        <br/>[color=red][/color] 颜色(支持颜色名比如red或者16进制比如#66ccff)
        <br/>[b][/b] 加粗
        <br/>[i][/i] 斜体
        <br/>[mask][/mask] 黑幕
        <br/>[collapse=标题][/collapse] 折叠
        <br/>[dice]1d10[/dice] 假骰娘
        <br/>回车换行
    </div>
</div>
<input type="checkbox" id="xss">
<label for="xss">xss过滤</label>
<button style="margin-right: 50px" onclick="bbcode2html()">解析</button>
<button onclick="document.getElementById('source').value = CODE_1">并列预设</button>
<button onclick="document.getElementById('source').value = CODE_2">嵌套预设</button>
<button onclick="document.getElementById('source').value = CODE_3">错位预设1</button>
<button onclick="document.getElementById('source').value = CODE_4">错位预设2</button>
<div id="result"></div>
<script>

  const CODE_1 = "[color=#FF0000]T[/color][color=#F3000C]h[/color][color=#E80017]i[/color][color=#DC0023]s[/color][color=#D1002E] [/color] [color=#C5003A]t[/color][color=#B90046]e[/color][color=#AE0051]x[/color][color=#A2005D]t[/color][color=#970068] [/color] [color=#8B0074]c[/color][color=#7F0080]h[/color][color=#74008B]a[/color][color=#680097]n[/color][color=#5D00A2]g[/color][color=#5100AE]e[/color][color=#4600B9]s[/color][color=#3A00C5] [/color] [color=#2E00D1]i[/color][color=#2300DC]n[/color][color=#1700E8] [/color] [color=#0C00F3]c[/color][color=#0000FF]o[/color][color=#000CF3]l[/color][color=#0017E8]o[/color][color=#0023DC]r[/color][color=#002ED1] [/color] [color=#003AC5]a[/color][color=#0046B9]s[/color][color=#0051AE] [/color] [color=#005DA2]i[/color][color=#006897]t[/color][color=#00748B] [/color] [color=#00807F]g[/color][color=#008B74]o[/color][color=#009768]e[/color][color=#00A25D]s[/color][color=#00AE51] [/color] [color=#00B946]a[/color][color=#00C53A]l[/color][color=#00D12E]o[/color][color=#00DC23]n[/color][color=#00E817]g[/color][color=#00F30C].[/color][color=#00FF00].[/color]";
  const CODE_2 = "[color=red]This text is red\n" +
    "[color=blue]This text is blue[/color]\n" +
    "[color=#00ff00][b]This text is green and [i]bold[/i].[/b] [color=00ffff]Another color change...[/color] green again.[/color]\n" +
    "This text is red[/color]\n" +
    "[collapse][b][color=yellow][collapse]This text is yellow.[/collapse][/color][/b][/collapse]\n" +
    "[color=gray]This text is gray.[/color]\n";
  const CODE_3 = "[dice]1d2[/dice][collapse=标题][dice]1d1[mask][/dice]xx[/mask]\n[mask][dice]1d1[/dice][/mask][/collapse]";
  const CODE_4 = "[mask][collapse=标题][dice]1d1[dice]1d1[/dice][/mask][/collapse][/dice]";

  const STATE_NORMAL = 0;
  const STATE_BBCODE_OPEN_START = 1;
  const STATE_BBCODE_CLOSE_START = 2;

  const TYPE_TEXT = 0;
  const TYPE_BBCODE_OPEN = 1;

  function transformColor(tagName, content, arg) {
    if (!arg) {
      return content;
    }
    if (arg.match(/^[0-9a-fA-F]{6}$/)) {
      arg = '#' + arg;
    }
    return `<span style="color:${arg}">${content}</span>`;
  }

  function transformCollapse(tagName, content, arg) {
    if (!arg) {
      arg = "点击展开"
    }
    return `<details><summary>${arg}</summary>${content}</details>`;
  }

  function transformMask(tagName, content, arg) {
    return `<div class="mask">${content}</div>`;
  }

  function transformDice(tagName, content, arg) {
    if (content.match(/^((\d+)|(\d*d\d+))(\+((\d+)|(\d*d\d+)))*$/)) {
      return `<div class="dice">假装有骰娘：${content}=${Math.round(Math.random() * 200)}</div>`;
    }
    return transformAsIs(tagName, content, arg);
  }

  function transformAsIs(tagName, content, arg) {
    let left;
    let right;
    if (tagName === 'b' || tagName === 'i') {
      left = '<';
      right = '>';
    } else {
      left = '[';
      right = ']';
    }
    let openTag;
    if (arg) {
      openTag = `${left}${tagName}=${arg}${right}`;
    } else {
      openTag = left + tagName + right;
    }
    return `${openTag}${content}${left}/${tagName}${right}`;
  }

  function transformTag(tagName, content, arg) {
    if (!content) {
      return '';
    }
    tagName = tagName.substring(1);
    switch (tagName) {
      case "mask": return transformMask(tagName, content, arg);
      case "dice": return transformDice(tagName, content, arg);
      case "color": return transformColor(tagName, content, arg);
      case "collapse": return transformCollapse(tagName, content, arg);
      default: return transformAsIs(tagName, content, arg);
    }
  }

  function filterXSS(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function bbcode2html() {
    let str = document.getElementById("source").value;
    console.log(str);

    if (document.getElementById("xss").checked) {
      str = filterXSS(str);
    }
    str = str.replace(/ /g, '&nbsp;');

    const stack = [];
    let state = STATE_NORMAL;
    let tmp = '';
    for (let idx = 0; idx < str.length; idx++) {
      const char = str[idx];
      switch (char) {
        case '[': {
          if (state === STATE_NORMAL && idx < str.length) {
            if (tmp.length > 0) {
              stack.push({type: TYPE_TEXT, value: tmp});
              tmp = '';
            }
            tmp = '[';
            if (str[idx + 1] === '/') {
              state = STATE_BBCODE_CLOSE_START;
              idx++;
            } else {
              state = STATE_BBCODE_OPEN_START;
            }
          } else if (state === STATE_BBCODE_OPEN_START || state === STATE_BBCODE_CLOSE_START) {
            if (tmp.length > 0) {
              stack.push({type: TYPE_TEXT, value: tmp});
              tmp = '[';
            }
          } else {
            tmp += char;
          }
          break;
        }
        case ']': {
          if (state === STATE_BBCODE_OPEN_START) {
            let arg;
            const argIdx = tmp.indexOf('=');
            if (argIdx > 0) {
              arg = tmp.substring(argIdx + 1);
              tmp = tmp.substring(0, argIdx);
            }
            stack.push({type: TYPE_BBCODE_OPEN, value: tmp, arg: arg});
            tmp = '';
            state = STATE_NORMAL;
          } else if (state === STATE_BBCODE_CLOSE_START) {
            let content = '';
            let successClosed = false;
            out: while (true) {
              const node = stack.pop();
              if (!node) {
                break;
              }
              switch (node.type) {
                case TYPE_TEXT: {
                  content = node.value + content;
                  break;
                }
                case TYPE_BBCODE_OPEN: {
                  if (node.value === tmp) {
                    stack.push({type: TYPE_TEXT, value: transformTag(node.value, content, node.arg)});
                    content = '';
                    successClosed = true;
                    break out;
                  } else {
                    content = transformTag(node.value, content, node.arg);
                  }
                }
              }
            }
            if (!successClosed) {
              content += '[/' + tmp.substring(1) + ']';
            }
            if (content.length > 0) {
              stack.push({type: TYPE_TEXT, value: content});
            }
            tmp = '';
            state = STATE_NORMAL;
          } else {
            tmp += char;
          }
          break;
        }
        case "\n": {
          tmp += '<br/>';
          break;
        }
        default: {
          tmp += char;
        }
      }
    }
    console.log(Object.assign({}, stack));
    let result = '';
    let node;
    while (node = stack.pop()) {
      if (node.type === TYPE_BBCODE_OPEN) {
        if (tmp.length > 0) {
          result += tmp;
          tmp = '';
        }
        result = transformTag(node.value, result, node.arg);
      } else if (node.type === TYPE_TEXT) {
        result = node.value + result;
      }
    }
    if (tmp.length > 0) {
      result += tmp;
    }
    console.log(result);
    document.getElementById("result").innerHTML = result;
  }
</script>
</body>
</html>
